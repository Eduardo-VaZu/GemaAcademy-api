generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model administrador {
  usuario_id           Int                    @id
  sede_id              Int?
  cargo                String                 @db.VarChar(100)
  area                 String?                @db.VarChar(100)
  sedes                sedes?                 @relation(fields: [sede_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios             usuarios               @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  descuentos_aplicados descuentos_aplicados[]
  pagos                pagos[]
  solicitudes_lesion   solicitudes_lesion[]
}

model alumnos {
  usuario_id          Int                  @id
  condiciones_medicas String?
  seguro_medico       String?              @db.VarChar(100)
  grupo_sanguineo     String?              @db.VarChar(5)
  usuarios            usuarios             @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  alumnos_contactos   alumnos_contactos[]
  cuentas_por_cobrar  cuentas_por_cobrar[]
  inscripciones       inscripciones[]
  recuperaciones      recuperaciones[]
  solicitudes_lesion  solicitudes_lesion[]
}

model alumnos_contactos {
  id              Int      @id @default(autoincrement())
  alumno_id       Int
  nombre_completo String   @db.VarChar(150)
  relacion        String?  @db.VarChar(50)
  telefono        String   @db.VarChar(20)
  es_principal    Boolean? @default(false)
  alumnos         alumnos  @relation(fields: [alumno_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
}

model canchas {
  id              Int               @id @default(autoincrement())
  sede_id         Int
  nombre          String            @db.VarChar(50)
  descripcion     String?           @db.VarChar(200)
  sedes           sedes             @relation(fields: [sede_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  horarios_clases horarios_clases[]
}

model catalogo_conceptos {
  id                 Int                  @id @default(autoincrement())
  codigo_interno     String?              @unique @db.VarChar(20)
  nombre             String               @db.VarChar(150)
  precio_base        Decimal              @db.Decimal(10, 2)
  activo             Boolean?             @default(true)
  cuentas_por_cobrar cuentas_por_cobrar[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model congelamientos {
  id                  Int                 @id @default(autoincrement())
  inscripcion_id      Int
  solicitud_lesion_id Int?
  fecha_inicio        DateTime            @db.Date
  fecha_fin           DateTime?           @db.Date
  dias_reconocidos    Int?                @default(0)
  estado              String?             @default("ACTIVO") @db.VarChar(20)
  inscripciones       inscripciones       @relation(fields: [inscripcion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  solicitudes_lesion  solicitudes_lesion? @relation(fields: [solicitud_lesion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model credenciales_usuario {
  usuario_id      Int       @id
  hash_contrasena String    @db.VarChar(255)
  ultimo_login    DateTime? @db.Timestamp(6)
  bloqueado       Boolean?  @default(false)
  usuarios        usuarios  @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model cuentas_por_cobrar {
  id                   Int                    @id @default(autoincrement())
  alumno_id            Int
  concepto_id          Int?
  detalle_adicional    String?                @db.VarChar(200)
  monto_final          Decimal                @db.Decimal(10, 2)
  fecha_vencimiento    DateTime               @db.Date
  estado               String?                @default("PENDIENTE") @db.VarChar(20)
  creado_en            DateTime?              @default(now()) @db.Timestamp(6)
  actualizado_en       DateTime?              @default(now()) @db.Timestamp(6)
  alumnos              alumnos                @relation(fields: [alumno_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  catalogo_conceptos   catalogo_conceptos?    @relation(fields: [concepto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  descuentos_aplicados descuentos_aplicados[]
  pagos                pagos[]
}

model direcciones {
  id                 Int       @id @default(autoincrement())
  direccion_completa String    @db.VarChar(255)
  distrito           String    @db.VarChar(100)
  ciudad             String?   @default("Lima") @db.VarChar(100)
  referencia         String?
  creado_en          DateTime? @default(now()) @db.Timestamp(6)
  sedes              sedes[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model horarios_clases {
  id                    Int                   @id @default(autoincrement())
  cancha_id             Int
  profesor_id           Int
  nivel_id              Int
  dia_semana            Int
  hora_inicio           DateTime              @db.Time(6)
  hora_fin              DateTime              @db.Time(6)
  capacidad_max         Int?                  @default(20)
  activo                Boolean?              @default(true)
  minutos_reserva_especifico Int?
  canchas               canchas               @relation(fields: [cancha_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  niveles_entrenamiento niveles_entrenamiento @relation(fields: [nivel_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  profesores            profesores            @relation(fields: [profesor_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  inscripciones         inscripciones[]
  recuperaciones        recuperaciones[]

  @@unique([cancha_id, dia_semana, hora_inicio], map: "unica_cancha_hora")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model inscripciones {
  id                   Int                    @id @default(autoincrement())
  alumno_id            Int
  horario_id           Int
  fecha_inscripcion    DateTime?              @default(dbgenerated("CURRENT_DATE")) @db.Date
  estado               String?                @default("ACTIVO") @db.VarChar(20)
  actualizado_en       DateTime?              @default(now()) @db.Timestamp(6)
  congelamientos       congelamientos[]
  alumnos              alumnos                @relation(fields: [alumno_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  horarios_clases      horarios_clases        @relation(fields: [horario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  registros_asistencia registros_asistencia[]

  @@unique([alumno_id, horario_id], map: "unica_inscripcion_alumno")
}

model metodos_pago {
  id     Int      @id @default(autoincrement())
  nombre String   @unique @db.VarChar(50)
  activo Boolean? @default(true)
  pagos  pagos[]
}

model niveles_entrenamiento {
  id                 Int               @id @default(autoincrement())
  nombre             String            @db.VarChar(50)
  precio_referencial Decimal?          @db.Decimal(10, 2)
  horarios_clases    horarios_clases[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model pagos {
  id                 Int                @id @default(autoincrement())
  cuenta_id          Int
  metodo_pago_id     Int
  monto_pagado       Decimal            @db.Decimal(10, 2)
  url_comprobante    String?            @db.VarChar(255)
  fecha_pago         DateTime?          @default(now()) @db.Timestamp(6)
  estado_validacion  String?            @default("PENDIENTE") @db.VarChar(20)
  revisado_por       Int?
  notas_validacion   String?            @db.VarChar(200)
  cuentas_por_cobrar cuentas_por_cobrar @relation(fields: [cuenta_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  metodos_pago       metodos_pago       @relation(fields: [metodo_pago_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  administrador      administrador?     @relation(fields: [revisado_por], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
}

model profesores {
  usuario_id           Int                    @id
  especializacion      String?                @db.VarChar(100)
  tarifa_hora          Decimal?               @db.Decimal(10, 2)
  horarios_clases      horarios_clases[]
  usuarios             usuarios               @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  registros_asistencia registros_asistencia[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recuperaciones {
  id                  Int                 @id @default(autoincrement())
  alumno_id           Int
  fecha_falta         DateTime            @db.Date
  motivo_falta        String?             @default("PERSONAL") @db.VarChar(50)
  horario_destino_id  Int
  fecha_programada    DateTime            @db.Date
  es_por_lesion       Boolean?            @default(false)
  solicitud_lesion_id Int?
  estado              String?             @default("PROGRAMADA") @db.VarChar(20)
  alumnos             alumnos             @relation(fields: [alumno_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  horarios_clases     horarios_clases     @relation(fields: [horario_destino_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  solicitudes_lesion  solicitudes_lesion? @relation(fields: [solicitud_lesion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([alumno_id, horario_destino_id, fecha_programada], map: "unica_recuperacion_slot")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model registros_asistencia {
  id             Int           @id @default(autoincrement())
  inscripcion_id Int
  fecha          DateTime      @db.Date
  estado         String?       @default("PRESENTE") @db.VarChar(20)
  comentario     String?
  registrado_por Int?
  registrado_en  DateTime?     @default(now()) @db.Timestamp(6)
  inscripciones  inscripciones @relation(fields: [inscripcion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  profesores     profesores?   @relation(fields: [registrado_por], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([inscripcion_id, fecha], map: "asistencia_unica_diaria")
}

model roles {
  id          Int        @id @default(autoincrement())
  nombre      String     @unique @db.VarChar(50)
  descripcion String?    @db.VarChar(200)
  usuarios    usuarios[]
}

model sedes {
  id                Int             @id @default(autoincrement())
  direccion_id      Int
  nombre            String          @db.VarChar(100)
  telefono_contacto String?         @db.VarChar(20)
  tipo_instalacion  String?         @db.VarChar(50)
  activo            Boolean?        @default(true)
  administrador     administrador[]
  canchas           canchas[]
  direcciones       direcciones     @relation(fields: [direccion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model solicitudes_lesion {
  id                   Int              @id @default(autoincrement())
  alumno_id            Int
  fecha_solicitud      DateTime?        @default(now()) @db.Timestamp(6)
  descripcion_lesion   String
  url_evidencia_medica String           @db.VarChar(255)
  estado               String?          @default("PENDIENTE") @db.VarChar(20)
  revisado_por         Int?
  notas_admin          String?
  congelamientos       congelamientos[]
  recuperaciones       recuperaciones[]
  alumnos              alumnos          @relation(fields: [alumno_id], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  administrador        administrador?   @relation(fields: [revisado_por], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
}

model tipos_documento {
  id          String     @id @db.VarChar(10)
  descripcion String     @db.VarChar(50)
  usuarios    usuarios[]
}

model usuarios {
  id                   Int                   @id @default(autoincrement())
  rol_id               Int
  tipo_documento_id    String?               @db.VarChar(10)
  numero_documento     String?               @db.VarChar(20)
  nombres              String                @db.VarChar(100)
  apellidos            String                @db.VarChar(100)
  email                String                @unique @db.VarChar(150)
  telefono_personal    String?               @db.VarChar(20)
  fecha_nacimiento     DateTime?             @db.Date
  genero               String?               @db.Char(1)
  activo               Boolean?              @default(true)
  creado_en            DateTime?             @default(now()) @db.Timestamp(6)
  actualizado_en       DateTime?             @default(now()) @db.Timestamp(6)
  administrador        administrador?
  alumnos              alumnos?
  credenciales_usuario credenciales_usuario?
  profesores           profesores?
  refresh_tokens       refresh_tokens[]
  roles                roles                 @relation(fields: [rol_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipos_documento      tipos_documento?      @relation(fields: [tipo_documento_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([tipo_documento_id, numero_documento], map: "uq_documento")
}

model descuentos_aplicados {
  id                      Int                @id @default(autoincrement())
  cuenta_id               Int
  tipo_beneficio_id       Int
  monto_nominal_aplicado  Decimal            @db.Decimal(10, 2)
  monto_dinero_descontado Decimal            @db.Decimal(10, 2)
  motivo_detalle          String?            @db.VarChar(255)
  aplicado_por            Int?
  fecha_aplicacion        DateTime?          @default(now()) @db.Timestamp(6)
  administrador           administrador?     @relation(fields: [aplicado_por], references: [usuario_id], onDelete: NoAction, onUpdate: NoAction)
  cuentas_por_cobrar      cuentas_por_cobrar @relation(fields: [cuenta_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipos_beneficio         tipos_beneficio    @relation(fields: [tipo_beneficio_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model tipos_beneficio {
  id                   Int                    @id @default(autoincrement())
  nombre               String                 @unique @db.VarChar(100)
  es_porcentaje        Boolean?               @default(false)
  valor_por_defecto    Decimal?               @db.Decimal(10, 2)
  activo               Boolean?               @default(true)
  descuentos_aplicados descuentos_aplicados[]
}

model refresh_tokens {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamp(6)
  created_at DateTime @default(now()) @db.Timestamp(6)
  revoked    Boolean  @default(false)
  usuarios   usuarios @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([usuario_id])
  @@index([token])
}

model configuracion_sistema {
  id                      Int      @id @default(autoincrement())
  tiempo_reserva_global   Int      @default(20) // El valor por defecto para todos
  creado_en               DateTime @default(now())
  actualizado_en          DateTime @updatedAt
}
